<%# Derive race from bet if not passed as local variable %>
<% race ||= bet&.race %>
<%# Use passed bet or find/create one %>
<% bet ||= current_user.bets.find_by(race: race) || Bet.new(submitted: false, race: race, user: current_user) %>
<div id="drivers-grid" class="w-full">
  <%= form_with model: bet,
    data: { controller: "sortable", action: "submit->sortable#updateForm" } do |f| %>
    <%= f.hidden_field :race_id, value: race.id %>

    <div class="overflow-x-auto -mx-6 md:mx-0">
      <table class="w-full text-sm text-gray-200 border-collapse min-w-[320px]">
        <%# <thead>
          <tr class="border-b border-gray-800">
            <th class="py-2 text-left text-sm md:text-base lg:text-xl px-3 md:px-6">Piloto</th>
            <th class="py-2 text-left text-sm md:text-base lg:text-xl px-3 md:px-6 hidden md:table-cell">Equipe</th>
            <th class="py-2 text-right text-sm md:text-base lg:text-xl w-12 md:w-20 px-3 md:px-6">Posição</th>
          </tr>
        </thead> %>

    <%
      # Use the drivers passed from controller if available (preserves saved order),
      # otherwise fall back to bet's ordered_drivers or default drivers list
      display_drivers = if drivers.is_a?(Array) && drivers.any?
                          drivers
                        elsif bet.persisted? && bet.bet_positions.any?
                          bet.ordered_drivers
                        else
                          Driver.all.order(:name)
                        end
    %>

    <tbody data-sortable-target="list">

      <% display_drivers.each_with_index do |driver, index| %>

      <% existing_position = bet.bet_positions.find { |bp| bp.driver_id == driver.id } if bet.persisted? %>

        <tr data-id="<%= driver.id %>"
          class="relative border-b border-gray-900 cursor-move"
          draggable="true">
          <td colspan="3" class="p-[1px]">
            <div class="relative rounded-lg bg-gradient-to-br from-white/10 to-white/5 hover:from-blue-500 hover:to-cyan-400 transition-all duration-500">
              <div class="bg-[#0a0a0a] rounded-lg flex items-center">

        <%# --- START HIDDEN FIELDS --- %>
          <% if existing_position %>
            <%= hidden_field_tag "bet[bet_positions_attributes][][id]", existing_position.id %>
          <% end %>

          <%= hidden_field_tag "bet[bet_positions_attributes][][driver_id]", driver.id %>

          <%# Ensure the value matches the current visual index %>
          <%= hidden_field_tag "bet[bet_positions_attributes][][position]", index + 1,
                id: nil,
                data: { sortable_target: "positionInput" } %>

          <%# --- END HIDDEN FIELDS --- %>

          <div class="py-2 font-medium text-gray-200 px-3 md:px-6 flex-1 min-w-0">
            <div class="flex flex-col items-center gap-1 md:gap-2">
              <% headshot_opacity = index + 1 > 10 ? 'opacity-40' : 'opacity-100' %>
              <% driver_name_opacity = index + 1 > 10 ? 'opacity-40' : 'opacity-100' %>
              <% if driver.headshot_url.present? %>
                <img src="<%= driver.headshot_url %>"
                     class="driver-headshot w-20 h-20 md:w-14 md:h-14 lg:w-20 lg:h-20 xl:w-24 xl:h-24 rounded-full flex-shrink-0 object-cover transition-opacity duration-300 <%= headshot_opacity %>"
                     alt="<%= driver.name %>"
                     data-sortable-target="headshot">
              <% else %>
                <%= image_tag 'avatar.png',
                    class: "driver-headshot w-[56px] h-[56px] max-w-[56px] lg:w-20 lg:h-20 lg:max-w-[80px] rounded-full flex-shrink-0 object-cover transition-opacity duration-300 #{headshot_opacity}",
                    alt: driver.name,
                    data: { sortable_target: "headshot" } %>
              <% end %>
              <div class="flex flex-col items-center text-center">
                <span class="driver-name text-xs md:text-sm lg:text-lg xl:text-xl font-medium transition-opacity duration-300 <%= driver_name_opacity %>" data-sortable-target="driverName"><%= driver.name %></span>
                <span class="team-name text-gray-400 text-xs md:text-sm lg:text-base xl:text-lg mt-0.5 transition-opacity duration-300 <%= driver_name_opacity %>" data-sortable-target="teamName"><%= driver.team %></span>
              </div>
            </div>
          </div>

          <div class="py-4 text-center w-16 flex-shrink-0">
            <div class="relative flex items-center justify-center">
              <span class="text-3xl font-black italic tracking-tighter tabular-nums position-highlight
                 <%= case index + 1
                     when 1 then 'text-yellow-400 drop-shadow-[0_0_8px_rgba(250,204,21,0.5)]' # Gold P1
                     when 2 then 'text-gray-300'    # Silver P2
                     when 3 then 'text-orange-400'  # Bronze P3
                     when 4..10 then 'text-white'   # Top 10 (P4-P10)
                     else 'text-gray-600'           # The Rest
                     end %>"
                 data-sortable-target="positionDisplay"
                 data-position="<%= index + 1 %>">
                <span class="text-sm opacity-50 not-italic mr-0.5">P</span><span class="position-number"><%= index + 1 %></span>
              </span>
            </div>
          </div>
              </div>
            </div>
          </td>
        </tr>
      <% end %>
      </tbody>
      </table>
    </div>

    <div class="mt-6 md:mt-8 flex flex-col sm:flex-row justify-end gap-3 md:gap-4 items-stretch sm:items-center">
      <% if bet.submitted? %>
        <div class="bg-green-900/50 text-green-200 px-3 py-2 md:px-4 text-sm md:text-base rounded border border-green-700">
          ✅ Aposta Confirmada
        </div>

      <% else %>
        <% show_success = local_assigns[:show_success] || false %>
        <div id="save-success-message" class="<%= show_success ? '' : 'hidden' %> bg-green-900/50 text-green-200 px-3 py-2 md:px-4 text-sm md:text-base rounded border border-green-700 transition-opacity duration-500">
          ✓ Salvo com sucesso
        </div>
        <% if show_success %>
          <script>
            (function() {
              var msg = document.getElementById('save-success-message');
              if (msg) {
                setTimeout(function() {
                  msg.style.opacity = '0';
                  setTimeout(function() {
                    if (msg) msg.classList.add('hidden');
                  }, 500);
                }, 3000);
              }
            })();
          </script>
        <% end %>

        <%= f.submit "Salvar Rascunho",
            class: "px-3 py-2 md:px-4 text-sm md:text-base bg-gray-700 hover:bg-gray-600 text-gray-200 rounded cursor-pointer border border-gray-600",
            data: { action: "click->sortable#updateForm" } %>

        <%= f.submit "Confirmar Aposta",
            class: "px-3 py-2 md:px-4 text-sm md:text-base bg-orange-600 hover:bg-orange-500 text-white font-bold rounded cursor-pointer",
            data: {
                action: "click->sortable#updateForm",
                confirm: "Tem certeza? Após confirmar, você não poderá alterar sua aposta."
            } %>
        <% end %>
    </div>

      <% end %>
  </div>
